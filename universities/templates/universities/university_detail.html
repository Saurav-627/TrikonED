{% extends 'base/base.html' %}
{% load static %}

{% block title %}{{ university.name }} - TrikonED{% endblock %}

{% block content %}
<main class="flex-1 w-full">
    <div class="px-8 py-4">
        <div class="flex flex-col w-full max-w-7xl mx-auto flex-1 gap-6">
            <!-- Header Image -->
            <div class="@container">
                <div class="bg-cover bg-center flex flex-col justify-end overflow-hidden bg-white rounded-xl min-h-80 shadow-sm"
                    style='background-image: linear-gradient(0deg, rgba(0, 0, 0, 0.5) 0%, rgba(0, 0, 0, 0) 40%), url("{% if university.image %}{{ university.image.url }}{% else %}https://images.unsplash.com/photo-1541339907198-e08756dedf3f?w=1200{% endif %}");'>
                </div>
            </div>

            <!-- Profile Header -->
            <div class="flex px-4 @container -mt-20">
                <div
                    class="flex w-full flex-col gap-4 @[520px]:flex-row @[520px]:justify-between @[520px]:items-end bg-white p-6 rounded-xl shadow-lg border border-border">
                    <div class="flex gap-6">
                        {% if university.logo %}
                        <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-lg min-h-32 w-32 shadow-md"
                            style='background-image: url("{{ university.logo.url }}");'></div>
                        {% else %}
                        <div class="bg-background rounded-lg min-h-32 w-32 shadow-md flex items-center justify-center">
                            <span class="text-5xl font-bold text-primary">{{ university.short_name|slice:":2"|upper }}</span>
                        </div>
                        {% endif %}
                        <div class="flex flex-col justify-center">
                            <h1 class="text-3xl font-black leading-tight text-text-primary mb-2">
                                {{ university.name }}</h1>
                            <p class="text-text-secondary text-base font-normal leading-normal flex items-center gap-1"> <span class="material-symbols-outlined text-base">location_on</span> {{ university.get_location_display }}</p>
                            {% if university.is_partner %}
                            <div
                                class="mt-2 inline-flex items-center gap-2 rounded-full bg-green-100 px-3 py-1 text-sm font-medium text-green-700 w-fit">
                                <span class="material-symbols-outlined text-base">verified</span>
                                <span>Official Partner</span>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="flex w-full max-w-[480px] gap-3 @[480px]:w-auto pt-4 @[520px]:pt-0">
                        {% comment %} <button
                            class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-background text-text-primary text-sm font-bold leading-normal tracking-[0.015em] flex-1 @[480px]:flex-auto hover:bg-primary/10 transition-colors border border-border">
                            <span class="truncate">Save to Wishlist</span>
                        </button> {% endcomment %}
                        {% if user.is_authenticated %}
                        <a href="?tab=programs"
                            class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-primary text-white text-sm font-bold leading-normal tracking-[0.015em] flex-1 @[480px]:flex-auto hover:opacity-90">
                            <span class="truncate">View Programs to Apply</span>
                        </a>
                        {% else %}
                        <a href="{% url 'students:register' %}?next={{ request.path }}"
                            class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-primary text-white text-sm font-bold leading-normal tracking-[0.015em] flex-1 @[480px]:flex-auto hover:opacity-90">
                            <span class="truncate">Sign Up to Apply</span>
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="px-4">
                <div class="flex border-b border-border gap-8 overflow-x-auto">
                    <a class="flex flex-col items-center justify-center border-b-[3px] {% if active_tab == 'overview' %}border-b-primary{% else %}border-b-transparent{% endif %} pb-[13px] pt-4 whitespace-nowrap"
                        href="?tab=overview">
                        <p
                            class="{% if active_tab == 'overview' %}text-primary{% else %}text-text-secondary hover:text-primary{% endif %} text-sm font-bold leading-normal tracking-[0.015em]">
                            Overview</p>
                    </a>
                    <a class="flex flex-col items-center justify-center border-b-[3px] {% if active_tab == 'programs' %}border-b-primary{% else %}border-b-transparent{% endif %} pb-[13px] pt-4 whitespace-nowrap"
                        href="?tab=programs">
                        <p
                            class="{% if active_tab == 'programs' %}text-primary{% else %}text-text-secondary hover:text-primary{% endif %} text-sm font-bold leading-normal tracking-[0.015em]">
                            Programs</p>
                    </a>
                    <a class="flex flex-col items-center justify-center border-b-[3px] {% if active_tab == 'scholarships' %}border-b-primary{% else %}border-b-transparent{% endif %} pb-[13px] pt-4 whitespace-nowrap"
                        href="?tab=scholarships">
                        <p
                            class="{% if active_tab == 'scholarships' %}text-primary{% else %}text-text-secondary hover:text-primary{% endif %} text-sm font-bold leading-normal tracking-[0.015em]">
                            Scholarships</p>
                    </a>
                    <a class="flex flex-col items-center justify-center border-b-[3px] {% if active_tab == 'visa' %}border-b-primary{% else %}border-b-transparent{% endif %} pb-[13px] pt-4 whitespace-nowrap"
                        href="?tab=visa">
                        <p
                            class="{% if active_tab == 'visa' %}text-primary{% else %}text-text-secondary hover:text-primary{% endif %} text-sm font-bold leading-normal tracking-[0.015em]">
                            Visa</p>
                    </a>
                    <a class="flex flex-col items-center justify-center border-b-[3px] {% if active_tab == 'contact' %}border-b-primary{% else %}border-b-transparent{% endif %} pb-[13px] pt-4 whitespace-nowrap"
                        href="?tab=contact">
                        <p
                            class="{% if active_tab == 'contact' %}text-primary{% else %}text-text-secondary hover:text-primary{% endif %} text-sm font-bold leading-normal tracking-[0.015em]">
                            Contact</p>
                    </a>
                    <a class="flex flex-col items-center justify-center border-b-[3px] {% if active_tab == 'stats' %}border-b-primary{% else %}border-b-transparent{% endif %} pb-[13px] pt-4 whitespace-nowrap"
                        href="?tab=stats">
                        <p
                            class="{% if active_tab == 'stats' %}text-primary{% else %}text-text-secondary hover:text-primary{% endif %} text-sm font-bold leading-normal tracking-[0.015em]">
                            Stats</p>
                    </a>
                </div>
            </div>

            <!-- Main Content Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 px-4">
                <!-- Left Column -->
                <div class="lg:col-span-2 flex flex-col gap-6">

                    {% if active_tab == 'overview' %}
                    <!-- About Card -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-border">
                        <h2 class="text-text-primary tracking-light text-xl font-bold leading-tight">About
                            {{ university.name }}</h2>
                        <div class="prose max-w-none">
                            <p
                                class="text-text-muted text-base font-normal leading-relaxed whitespace-pre-line break-words">
                                {{ university.description }}</p>
                        </div>
                    </div>

                    <!-- Highlights/Info Cards -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div
                            class="bg-white p-4 rounded-xl shadow-sm border border-border flex flex-col items-center text-center">
                            <span class="material-symbols-outlined text-primary text-3xl">calendar_month</span>
                            <p class="mt-2 text-sm text-text-secondary">Established</p>
                            <p class="font-bold text-text-primary">{{ university.established_year }}</p>
                        </div>
                        <div
                            class="bg-white p-4 rounded-xl shadow-sm border border-border flex flex-col items-center text-center">
                            <span class="material-symbols-outlined text-primary text-3xl">school</span>
                            <p class="mt-2 text-sm text-text-secondary">Accreditation</p>
                            <p class="font-bold text-text-primary">{{ university.accreditation|truncatewords:2 }}</p>
                        </div>
                        <div
                            class="bg-white p-4 rounded-xl shadow-sm border border-border flex flex-col items-center text-center">
                            <span class="material-symbols-outlined text-primary text-3xl">account_balance</span>
                            <p class="mt-2 text-sm text-text-secondary">University Type</p>
                            <p class="font-bold text-text-primary">{{ university.university_type|title }}
                            </p>
                        </div>
                        {% if university.ranking %}
                        <div
                            class="bg-white p-4 rounded-xl shadow-sm border border-border flex flex-col items-center text-center">
                            <span class="material-symbols-outlined text-primary text-3xl">workspace_premium</span>
                            <p class="mt-2 text-sm text-text-secondary">QS Ranking</p>
                            <p class="font-bold text-text-primary">#{{ university.ranking }}</p>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Facilities Card -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-border">
                        <h2 class="text-text-primary tracking-light text-xl font-bold leading-tight mb-4">
                            On-Campus Facilities</h2>
                        <div class="prose max-w-none">
                            <p class="text-text-muted text-base leading-relaxed whitespace-pre-line break-words">{{ university.facilities }}</p>
                        </div>
                    </div>

                    {% elif active_tab == 'programs' %}
                    <!-- Programs List -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-border">
                        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 mb-6">
                            <h2 class="text-text-primary tracking-light text-xl font-bold leading-tight">
                                Programs Offered</h2>

                            <!-- Program Level Filter -->
                            {% if available_levels %}
                            <div class="flex items-center gap-2">
                                <label class="text-sm font-medium text-text-secondary">Filter by Level:</label>
                                <select id="levelFilter" onchange="filterByLevel(this.value)"
                                    class="pl-2 pr-8 py-2 border border-border rounded-lg text-sm focus:border-primary focus:ring-1 focus:ring-primary outline-none">
                                    <option value="">All Levels</option>
                                    {% for level in available_levels %}
                                    <option value="{{ level.name }}" {% if selected_level == level.name %}selected{% endif %}>
                                        {{ level.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                                {% if selected_level %}
                                <a href="?tab=programs"
                                    class="px-3 py-2 text-sm text-primary hover:text-primary/80 font-medium">
                                    Clear
                                </a>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>

                        <div class="space-y-4">
                            {% for program in filtered_programs %}
                            <div class="border border-border rounded-xl p-4 hover:border-primary transition-all">
                                <div class="flex items-start justify-between gap-4">
                                    <div class="flex-1">
                                        <h3 class="font-bold text-lg text-text-primary mb-1">{{ program.name }}</h3>
                                        <p class="text-sm text-text-secondary mb-2">
                                            <span
                                                class="inline-flex items-center px-2 py-1 rounded-full bg-primary-10 text-primary text-xs font-medium mr-2">
                                                {{ program.type.level.name }}
                                            </span>
                                            {{ program.type.name }} • {{ program.delivery_type|title }}
                                        </p>
                                        <p class="text-sm text-text-muted">{{ program.description|truncatewords:20 }}</p>
                                    </div>
                                    <a href="{% url 'programs:detail' program.slug %}"
                                        class="px-4 py-2 bg-primary-10 border border-primary text-primary rounded-lg hover:bg-primary hover:text-white transition-all whitespace-nowrap text-sm font-bold">
                                        View Details
                                    </a>
                                </div>
                            </div>
                            {% empty %}
                            <p class="text-text-secondary text-center py-8">
                                {% if selected_level %}
                                No {{ selected_level }} programs available.
                                {% else %}
                                No programs available yet.
                                {% endif %}
                            </p>
                            {% endfor %}
                        </div>
                    </div>

                    <script>
                        function filterByLevel(level) {
                            const url = new URL(window.location);
                            url.searchParams.set('tab', 'programs');
                            if (level) {
                                url.searchParams.set('level', level);
                            } else {
                                url.searchParams.delete('level');
                            }
                            window.location.href = url.toString();
                        }
                    </script>

                    {% elif active_tab == 'scholarships' %}
                    <!-- Scholarships -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-border">
                        <h2 class="text-text-primary tracking-light text-xl font-bold leading-tight mb-6">
                            Available Scholarships</h2>
                        <div class="space-y-4">
                            {% for scholarship in university.scholarships.all %}
                            <div class="border-l-4 border-primary bg-primary/5 rounded-lg p-4">
                                <div class="flex items-start justify-between mb-2">
                                    <h3 class="font-bold text-text-primary">{{ scholarship.name }}</h3>
                                    {% if scholarship.renewable %}
                                    <span
                                        class="px-2 py-1 bg-green-100 text-green-700 text-xs rounded-full font-medium">Renewable</span>
                                    {% endif %}
                                </div>
                                <p class="text-2xl font-bold text-primary mb-2">AED {{ scholarship.amount }}</p>
                                <p class="text-sm text-text-muted mb-2">{{ scholarship.coverage }}
                                </p>
                                <p class="text-sm text-text-muted"><span class="font-semibold">Eligibility:</span>
                                    {{ scholarship.eligibility }}</p>
                                {% if scholarship.application_deadline %}
                                <p class="text-sm text-text-muted mt-2"><span class="font-semibold">Deadline:</span>
                                    {{ scholarship.application_deadline|date:"F d, Y" }}</p>
                                {% endif %}
                            </div>
                            {% empty %}
                            <p class="text-text-muted text-center py-8">No scholarships available at
                                this time.</p>
                            {% endfor %}
                        </div>
                    </div>

                    {% elif active_tab == 'visa' %}
                    <!-- Visa Information -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-border">
                        <h2 class="text-text-primary tracking-light text-xl font-bold leading-tight mb-6">
                            Visa Sponsorship Information</h2>
                        {% for visa in university.visa_sponsorships.all %}
                        <div class="space-y-4">
                            {% if visa.offers_visa %}
                            <div class="flex items-center gap-3 p-4 bg-green-50 rounded-lg border border-green-200">
                                <span class="material-symbols-outlined text-green-600 text-3xl">check_circle</span>
                                <div>
                                    <p class="font-bold text-green-700">Visa Sponsorship Available
                                    </p>
                                    <p class="text-sm text-green-600">This university offers visa
                                        sponsorship for international students</p>
                                </div>
                            </div>
                            {% else %}
                            <div class="flex items-center gap-3 p-4 bg-orange-50 rounded-lg border border-orange-200">
                                <span class="material-symbols-outlined text-orange-600 text-3xl">info</span>
                                <div>
                                    <p class="font-bold text-orange-700">Limited Visa Sponsorship
                                    </p>
                                    <p class="text-sm text-orange-600">Please contact the
                                        university for specific visa requirements</p>
                                </div>
                            </div>
                            {% endif %}
                            {% if visa.details %}
                            <div class="prose max-w-none mt-4">
                                <p class="text-text-muted leading-relaxed whitespace-pre-line break-words">{{ visa.details }}</p>
                            </div>
                            {% endif %}
                        </div>
                        {% empty %}
                        <p class="text-text-secondary text-center py-8">Visa information not available.
                            Please contact the university directly.</p>
                        {% endfor %}
                    </div>

                    {% elif active_tab == 'contact' %}
                    <!-- Contact Information -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-border">
                        <h2 class="text-text-primary tracking-light text-xl font-bold leading-tight mb-6">
                            Contact Information</h2>
                        <div class="space-y-4">
                            <div class="flex items-start gap-4">
                                <span class="material-symbols-outlined text-secondary text-2xl">mail</span>
                                <div>
                                    <p class="text-sm font-semibold text-text-primary mb-1">Email</p>
                                    <a href="mailto:{{ university.contact_info.email }}"
                                        class="text-text-secondary hover:text-primary">{{ university.contact_info.email }}</a>
                                </div>
                            </div>
                            <div class="flex items-start gap-4">
                                <span class="material-symbols-outlined text-secondary text-2xl">phone</span>
                                <div>
                                    <p class="text-sm font-semibold text-text-primary mb-1">Phone</p>
                                    <p class="text-text-secondary">{{ university.contact_info.phone }}
                                    </p>
                                </div>
                            </div>
                            {% if university.contact_info.website %}
                            <div class="flex items-start gap-4">
                                <span class="material-symbols-outlined text-secondary text-2xl">language</span>
                                <div>
                                    <p class="text-sm font-semibold text-text-primary mb-1">Website</p>
                                    <a href="{{ university.contact_info.website }}" target="_blank"
                                        class="text-text-secondary hover:text-primary">Visit Website
                                        →</a>
                                </div>
                            </div>
                            {% endif %}
                            {% if university.contact_info.address %}
                            <div class="flex items-start gap-4">
                                <span class="material-symbols-outlined text-secondary text-2xl">location_on</span>
                                <div>
                                    <p class="text-sm font-semibold text-text-primary mb-1">Address</p>
                                    <p class="text-text-secondary">{{ university.contact_info.address }}
                                    </p>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    {% elif active_tab == 'stats' %}
                    <!-- Statistics -->
                    {% if latest_stats %}
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-border">
                        <h2 class="text-text-primary tracking-light text-xl font-bold leading-tight mb-6">
                            Student Statistics ({{ latest_stats.academic_year }})</h2>
                        <!-- Stats Grid -->
                        {% if latest_stats %}
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                            {% if latest_stats.total_enrollment %}
                            <div class="bg-background rounded-lg p-4 text-center">
                                <p class="text-sm text-text-secondary mb-1">Total Students</p>
                                <p class="text-3xl font-bold text-secondary">{{ latest_stats.total_enrollment|floatformat:0 }}</p>
                            </div>
                            {% endif %}

                            {% if latest_stats.international_enrollment %}
                            <div class="bg-background rounded-lg p-4 text-center">
                                <p class="text-sm text-text-secondary mb-1">International</p>
                                <p class="text-3xl font-bold text-secondary">{{ latest_stats.international_enrollment|floatformat:0 }}
                                </p>
                            </div>
                            {% endif %}

                            {% if latest_stats.faculty_count %}
                            <div class="bg-background rounded-lg p-4 text-center">
                                <p class="text-sm text-text-secondary mb-1">Faculty Members</p>
                                <p class="text-3xl font-bold text-secondary">{{ latest_stats.faculty_count|floatformat:0 }}</p>
                            </div>
                            {% endif %}

                            {% if latest_stats.male_students and latest_stats.female_students %}
                            <div class="bg-background rounded-lg p-4 text-center">
                                <p class="text-sm text-text-secondary mb-1">Gender Ratio</p>
                                <p class="text-3xl font-bold text-secondary">
                                    {% widthratio latest_stats.male_students latest_stats.total_enrollment 100 as male_percent %}
                                    {{ male_percent }}% M
                                </p>
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                            {% if latest_stats.male_students %}
                            <div class="text-center p-4 bg-background rounded-lg">
                                <p class="text-3xl font-bold text-secondary">{{ latest_stats.male_students }}</p>
                                <p class="text-sm text-text-secondary mt-1">Male Students</p>
                            </div>
                            {% endif %}
                            {% if latest_stats.female_students %}
                            <div class="text-center p-4 bg-background rounded-lg">
                                <p class="text-3xl font-bold text-secondary">{{ latest_stats.female_students }}</p>
                                <p class="text-sm text-text-secondary mt-1">Female Students</p>
                            </div>
                            {% endif %}
                            {% if latest_stats.extra_data %}
                            {% for key, value in latest_stats.extra_data.items %}
                            <div class="text-center p-4 bg-background rounded-lg">
                                <p class="text-3xl font-bold text-secondary">{{ value }}</p>
                                <p class="text-sm text-text-secondary mt-1">{{ key|title }}</p>
                            </div>
                            {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                    {% else %}
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-border">
                        <p class="text-text-secondary text-center py-8">No statistics available at this
                            time.</p>
                    </div>
                    {% endif %}
                    {% endif %}

                </div>

                <!-- Right Column (Sidebar) -->
                <div class="lg:col-span-1 flex flex-col gap-6">
                    <!-- Enrollment Statistics Card -->
                    {% if enrollment_history %}
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-border">
                        <h2 class="text-text-primary tracking-light text-xl font-bold leading-tight pb-3">
                            Enrollment Trend</h2>
                        <div class="mt-4 h-48 flex items-end gap-2">
                            {% for stat in enrollment_history reversed %}
                            {% widthratio stat.total_enrollment enrollment_history.0.total_enrollment 100 as height_percent %}
                            <div class="flex-1 bg-primary/20 rounded-t-md hover:bg-primary transition-colors"
                                style="height: {{ height_percent }}%;"
                                title="{{ stat.academic_year }}: {{ stat.total_enrollment }} students"></div>
                            {% endfor %}
                        </div>
                        <div class="flex justify-around text-xs text-text-secondary mt-2">
                            {% for stat in enrollment_history reversed %}
                            <span>'{{ stat.academic_year|slice:"-2:" }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Quick Actions -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-border">
                        <h3 class="text-text-primary font-bold text-lg mb-4">Quick Actions</h3>
                        <div class="space-y-3">
                            {% if user.is_authenticated %}
                            <a href="?tab=programs"
                                class="block w-full px-4 py-3 bg-primary text-white text-center font-bold rounded-lg hover:opacity-90 transition-all">
                                View Programs to Apply
                            </a>
                            {% else %}
                            <a href="{% url 'students:register' %}?next={{ request.path }}"
                                class="block w-full px-4 py-3 bg-primary text-white text-center font-bold rounded-lg hover:opacity-90 transition-all">
                                Sign Up to Apply
                            </a>
                            {% endif %}
                            <a href="{{ university.contact_info.website }}"
                                class="block w-full px-4 py-3 bg-secondary text-white text-center font-bold rounded-lg hover:opacity-90 transition-all border border-border">
                                Visit Website
                            </a>
                        </div>
                    </div>

                    <!-- Accepted Curricula -->
                    {% if university.accepted_curricula.all %}
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-border">
                        <h3 class="text-text-primary font-bold text-lg mb-4">Accepted Curricula</h3>
                        <div class="flex flex-wrap gap-2">
                            {% for uc in university.accepted_curricula.all %}
                            <span class="px-3 py-1 bg-primary/10 text-primary rounded-full text-sm font-medium">
                                {{ uc.curriculum.name }}
                            </span>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</main>
{% endblock %}