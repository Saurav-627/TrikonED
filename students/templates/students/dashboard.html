{% extends 'base/base.html' %}
{% load static %}

{% block title %}Dashboard - TrikonED{% endblock %}

{% block content %}
<main class="flex-1 w-full bg-background">
    <!-- Dashboard Header -->
    <section class="bg-white border-b border-border py-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-black text-text-primary mb-2">
                        Welcome back, {{ user.first_name|default:user.username }}!
                    </h1>
                    <p class="text-text-secondary">{{ user.email }}</p>
                </div>
                {% comment %} <a href="{% url 'applications:wizard' %}"
                    class="px-6 py-3 bg-primary text-white font-bold rounded-lg hover:opacity-90 transition-all">
                    + New Application
                </a> {% endcomment %}
            </div>
        </div>
    </section>

    {% if not profile_complete %}
    <div class="bg-orange-100 border-b border-orange-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3">
            <div class="flex items-center justify-between flex-wrap gap-4">
                <div class="flex items-center gap-3">
                    <span class="material-symbols-outlined text-orange-600">warning</span>
                    <p class="text-orange-800 font-medium">Your profile is incomplete. Please
                        complete your profile to submit applications.</p>
                </div>
                <a href="{% url 'students:profile' %}" class="text-sm font-bold text-orange-700 hover:underline">
                    Complete Profile &rarr;
                </a>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Dashboard Content -->
    <section class="py-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">

            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-primary-10 rounded-xl shadow-sm border-l-4 border-primary p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-text-secondary mb-1">Total Applications</p>
                            <p class="text-3xl font-bold text-text-primary">{{ applications.count }}</p>
                        </div>
                        <div class="size-12 bg-primary-20 rounded-xl flex items-center justify-center">
                            <span class="material-symbols-outlined text-primary text-2xl">description</span>
                        </div>
                    </div>
                </div>

                <div class="bg-accent-20 rounded-xl shadow-sm border-l-4 border-accent p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-text-secondary mb-1">Pending Review</p>
                            <p class="text-3xl font-bold text-text-primary">
                                {{ pending_count }}
                            </p>
                        </div>
                        <div class="size-12 bg-accent-30 rounded-xl flex items-center justify-center">
                            <span class="material-symbols-outlined text-orange-700 text-2xl">schedule</span>
                        </div>
                    </div>
                </div>

                <div class="bg-secondary-10 rounded-xl shadow-sm border-l-4 border-secondary p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-secondary mb-1">Documents</p>
                            <p class="text-3xl font-bold text-secondary ">{{ documents.count }}</p>
                        </div>
                        <div class="size-12 bg-secondary-20 rounded-xl flex items-center justify-center">
                            <span class="material-symbols-outlined text-secondary text-2xl">folder</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Content Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

                <!-- Applications List -->
                <div class="lg:col-span-2">
                    <div class="bg-white rounded-xl shadow-sm border border-border p-6">
                        <h2 class="text-2xl font-bold text-text-primary mb-6">My Applications</h2>

                        {% if applications %}
                        <div class="space-y-4">
                            {% for application in applications %}
                            <div class="border border-border rounded-xl p-5 hover:shadow-md transition-all">
                                <div class="flex items-start justify-between mb-3">
                                    <div class="flex-1">
                                        <h3 class="text-lg font-bold text-text-primary mb-1">{{ application.program.name }}</h3>
                                        <p class="text-sm text-text-secondary">{{ application.university.name }}</p>
                                    </div>
                                    <span class="px-3 py-1 rounded-full text-xs font-bold
                                        {% if application.status == 'accepted' %}bg-green-100 text-green-700
                                        {% elif application.status == 'rejected' %}bg-red-100 text-red-700
                                        {% elif application.status == 'pending' or application.status == 'under_review' %}bg-orange-100 text-orange-700
                                        {% elif application.status == 'draft' %}bg-gray-100 text-text-secondary
                                        {% else %}bg-blue-100 text-blue-700{% endif %}">
                                        {{ application.get_status_display }}
                                    </span>
                                </div>

                                <!-- Status Message -->
                                <div class="mt-3 p-3 rounded-lg 
                                    {% if application.status == 'accepted' %}bg-green-50 border border-green-200
                                    {% elif application.status == 'rejected' %}bg-red-50 border border-red-200
                                    {% elif application.status == 'under_review' %}bg-blue-50 border border-blue-200
                                    {% else %}bg-gray-50 border border-gray-200
                                    {% endif %}">
                                    <p class="text-sm 
                                        {% if application.status == 'accepted' %}text-green-700
                                        {% elif application.status == 'rejected' %}text-red-700
                                        {% elif application.status == 'under_review' %}text-blue-700
                                        {% else %}text-gray-700
                                        {% endif %}">
                                        {{ application.get_status_message }}
                                    </p>
                                </div>

                                <div class="mt-3 flex items-center text-sm text-text-secondary mb-4">
                                    <span class="material-symbols-outlined text-base mr-1">calendar_today</span>
                                    Applied on {{ application.applied_on|date:"M d, Y" }}
                                </div>

                                <!-- Timeline Preview -->
                                <div class="flex items-center space-x-2 mb-4">
                                    {% with log_count=application.logs.count %}
                                    <div
                                        class="flex-1 h-2 {% if log_count >= 1 %}bg-primary{% else %}bg-gray-200 {% endif %} rounded-full">
                                    </div>
                                    <div
                                        class="flex-1 h-2 {% if log_count >= 2 %}bg-primary{% else %}bg-gray-200 {% endif %} rounded-full">
                                    </div>
                                    <div
                                        class="flex-1 h-2 {% if log_count >= 3 %}bg-primary{% else %}bg-gray-200 {% endif %} rounded-full">
                                    </div>
                                    {% endwith %}
                                </div>

                                <div class="flex gap-3">
                                    <a href="{% url 'applications:detail' application.application_id %}"
                                        class="flex-1 text-center px-4 py-2 bg-primary-10 border border-primary text-primary font-bold rounded-lg hover:bg-primary hover:text-white transition-all">
                                        View Details
                                    </a>
                                    {% if application.status == 'pending' %}
                                    <a href="{% url 'applications:cancel' application.application_id %}"
                                        onclick="return confirm('Are you sure you want to cancel this application? This action cannot be undone.');"
                                        class="flex-1 text-center px-4 py-2 bg-red-100 text-red-700 font-bold rounded-lg hover:bg-red-200 transition-all">
                                        Cancel Application
                                    </a>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="text-center py-12">
                            <div class="size-20 mx-auto text-text-secondary/30 mb-4">
                                <span class="material-symbols-outlined" style="font-size: 80px;">description</span>
                            </div>
                            <h3 class="text-lg font-bold text-text-primary mb-2">No applications yet</h3>
                            <p class="text-text-secondary mb-6">Start your journey by creating your first
                                application</p>
                            <a href="{% url 'applications:wizard' %}"
                                class="inline-flex items-center px-6 py-3 bg-primary text-white font-bold rounded-lg hover:opacity-90 transition-all">
                                Create Application
                                <span class="material-symbols-outlined ml-2">add</span>
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Sidebar -->
                <div class="lg:col-span-1 space-y-6">

                    <!-- My Profile -->
                    <div class="bg-white rounded-xl shadow-sm border border-border p-6">
                        <h3 class="text-lg font-bold text-text-primary mb-4">My Profile</h3>
                        <div class="flex items-center gap-4 mb-4">
                            {% if user.profile_picture %}
                            <img src="{{ user.profile_picture.url }}" alt="Profile"
                                class="w-12 h-12 rounded-full object-cover border-2 border-primary">
                            {% else %}
                            <div
                                class="w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center text-primary font-bold text-xl">
                                {{ user.first_name|first }}{{ user.last_name|first }}
                            </div>
                            {% endif %}
                            <div>
                                <p class="font-bold text-text-primary">{{ user.get_full_name }}</p>
                                <p class="text-xs text-text-secondary">{{ user.email }}</p>
                            </div>
                        </div>
                        <div class="space-y-2 text-sm text-text-secondary mb-4">
                            <p><span class="font-medium text-text-primary">Phone:</span> {{ user.phone }}
                            </p>
                            <p><span class="font-medium text-text-primary">Nationality:</span> {{ user.nationality }}
                            </p>
                        </div>
                        <a href="{% url 'students:profile' %}"
                            class="block w-full text-center px-4 py-2 bg-primary-10 text-primary font-bold rounded-lg hover:bg-primary hover:text-white transition-all">
                            Edit Profile
                        </a>
                    </div>

                    <!-- Documents -->
                    <div class="bg-white rounded-xl shadow-sm border border-border p-6">
                        <h3 class="text-lg font-bold text-text-primary mb-4 flex items-center justify-between">
                            <span>My Documents</span>
                            <span class="text-sm font-normal text-text-secondary">{{ documents.count }}</span>
                        </h3>

                        {% if documents %}
                        <div class="space-y-3 mb-4">
                            {% for doc in documents|slice:":5" %}
                            <div class="flex items-center justify-between p-3 bg-secondary-10 rounded-lg">
                                <div class="flex items-center flex-1 min-w-0">
                                    <span
                                        class="material-symbols-outlined text-secondary flex-shrink-0 mr-2">description</span>
                                    <div class="min-w-0 flex-1">
                                        <p class="text-sm font-medium text-secondary truncate">{{ doc.get_doc_type_display }}</p>
                                        <p class="text-xs text-secondary">{{ doc.uploaded_at|date:"M d, Y" }}</p>
                                    </div>
                                </div>
                                <a href="{{ doc.file_url.url }}" target="_blank"
                                    class="ml-2 text-secondary hover:text-primary/80">
                                    <span class="material-symbols-outlined">download</span>
                                </a>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <p class="text-sm text-text-secondary mb-4">No documents uploaded yet</p>
                        {% endif %}

                        <a href="{% url 'students:upload_document' %}"
                            class="block w-full text-center px-4 py-2 bg-primary-10 text-primary font-bold rounded-lg hover:bg-primary hover:text-white transition-all">
                            Upload Document
                        </a>
                    </div>

                    <!-- English Proficiency Test Scores -->
                    <div class="bg-white rounded-xl shadow-sm border border-border p-6">
                        <h3 class="text-lg font-bold text-text-primary mb-4 flex items-center justify-between">
                            <span>Test Scores</span>
                            <span class="text-sm font-normal text-text-secondary">{{ test_scores|length }}</span>
                        </h3>

                        {% if expired_test_scores %}
                        <div class="mb-4 p-3 bg-red-100 border border-red-200 rounded-lg">
                            <div class="flex items-start gap-2">
                                <span class="material-symbols-outlined text-red-600 text-sm">warning</span>
                                <div class="flex-1">
                                    <p class="text-sm font-medium text-red-700">
                                        {{ expired_test_scores|length }} test score{{ expired_test_scores|length|pluralize }} expired
                                    </p>
                                    <p class="text-xs text-red-600 mt-1">
                                        Please add new test scores to continue applying
                                    </p>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        {% if test_scores %}
                        <div class="space-y-3 mb-4">
                            {% for score in test_scores|slice:":3" %}
                            <div class="flex items-center justify-between p-3 bg-secondary-10 rounded-lg">
                                <div class="flex items-center flex-1 min-w-0">
                                    <span
                                        class="material-symbols-outlined text-secondary flex-shrink-0 mr-2">school</span>
                                    <div class="min-w-0 flex-1">
                                        <p class="text-sm font-medium text-secondary">{{ score.test_type }}</p>
                                        <p class="text-xs text-secondary">
                                            Overall: {{ score.overall_score|default:"N/A" }} | Expires: {{ score.expiry_date|date:"M d, Y" }}
                                        </p>
                                    </div>
                                </div>
                                <a href="{% url 'students:edit_test_score' score.pk %}"
                                    class="ml-2 text-secondary hover:text-primary/80">
                                    <span class="material-symbols-outlined">edit</span>
                                </a>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <p class="text-sm text-text-secondary mb-4">No test scores added yet</p>
                        {% endif %}

                        <div class="flex gap-2">
                            <a href="{% url 'students:add_test_score' %}"
                                class="flex-1 text-center px-4 py-2 bg-primary-10 text-primary font-bold rounded-lg hover:bg-primary hover:text-white transition-all">
                                Add Test Score
                            </a>
                            {% if test_scores %}
                            <a href="{% url 'students:test_scores' %}"
                                class="flex-1 text-center px-4 py-2 bg-secondary-10 text-secondary font-bold rounded-lg hover:bg-secondary hover:text-black transition-all">
                                View All
                            </a>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="bg-white rounded-xl shadow-sm border border-border p-6">
                        <h3 class="text-lg font-bold text-text-primary mb-4">Quick Actions</h3>
                        <div class="space-y-2">
                            <a href="{% url 'universities:list' %}"
                                class="block px-4 py-3 bg-secondary-10 rounded-lg hover:text-black transition-all text-secondary">
                                Browse Universities
                            </a>
                            <a href="{% url 'programs:list' %}"
                                class="block px-4 py-3 bg-secondary-10 rounded-lg  hover:text-black transition-all text-secondary">
                                Explore Programs
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</main>
{% endblock %}