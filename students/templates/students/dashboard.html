{% extends 'base/base.html' %}
{% load static %}

{% block title %}Dashboard - TrikonED{% endblock %}

{% block content %}
<main class="flex-1 w-full bg-background-light dark:bg-background-dark">
    <!-- Dashboard Header -->
    <section class="bg-white dark:bg-[#1a1307] border-b border-[#e7e2da] dark:border-[#3a2d1b] py-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-black text-[#181510] dark:text-white mb-2">
                        Welcome back, {{ user.first_name|default:user.username }}!
                    </h1>
                    <p class="text-[#8d7a5e] dark:text-[#a19077]">{{ user.email }}</p>
                </div>
                <a href="{% url 'applications:create' %}"
                    class="px-6 py-3 bg-primary text-white font-bold rounded-lg hover:opacity-90 transition-all">
                    + New Application
                </a>
            </div>
        </div>
    </section>

    {% if not profile_complete %}
    <div class="bg-orange-100 dark:bg-orange-900/30 border-b border-orange-200 dark:border-orange-800">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3">
            <div class="flex items-center justify-between flex-wrap gap-4">
                <div class="flex items-center gap-3">
                    <span class="material-symbols-outlined text-orange-600 dark:text-orange-400">warning</span>
                    <p class="text-orange-800 dark:text-orange-200 font-medium">Your profile is incomplete. Please
                        complete your profile to submit applications.</p>
                </div>
                <a href="{% url 'students:profile' %}"
                    class="text-sm font-bold text-orange-700 dark:text-orange-300 hover:underline">
                    Complete Profile &rarr;
                </a>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Dashboard Content -->
    <section class="py-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">

            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-primary-10 dark:bg-[#1a1307] rounded-xl shadow-sm border-l-4 border-primary p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-[#8d7a5e] dark:text-[#a19077] mb-1">Total Applications</p>
                            <p class="text-3xl font-bold text-[#181510] dark:text-white">{{ applications.count }}</p>
                        </div>
                        <div class="size-12 bg-primary-20 rounded-xl flex items-center justify-center">
                            <span class="material-symbols-outlined text-primary text-2xl">description</span>
                        </div>
                    </div>
                </div>

                <div class="bg-accent-20 dark:bg-[#1a1307] rounded-xl shadow-sm border-l-4 border-accent p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-[#8d7a5e] dark:text-[#a19077] mb-1">Pending Review</p>
                            <p class="text-3xl font-bold text-[#181510] dark:text-white">
                                {{ pending_count }}
                            </p>
                        </div>
                        <div
                            class="size-12 bg-accent-30 dark:bg-orange-900/20 rounded-xl flex items-center justify-center">
                            <span class="material-symbols-outlined text-orange-700 text-2xl">schedule</span>
                        </div>
                    </div>
                </div>

                <div class="bg-secondary-10 dark:bg-[#1a1307] rounded-xl shadow-sm border-l-4 border-secondary p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-secondary dark:text-[#a19077] mb-1">Documents</p>
                            <p class="text-3xl font-bold text-text-secondary  dark:text-white">{{ documents.count }}</p>
                        </div>
                        <div class="size-12 bg-secondary-20 dark:bg-secondary-30 rounded-xl flex items-center justify-center">
                            <span class="material-symbols-outlined text-text-secondary text-2xl">folder</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Content Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

                <!-- Applications List -->
                <div class="lg:col-span-2">
                    <div
                        class="bg-white dark:bg-[#1a1307] rounded-xl shadow-sm border border-[#e7e2da] dark:border-[#3a2d1b] p-6">
                        <h2 class="text-2xl font-bold text-[#181510] dark:text-white mb-6">My Applications</h2>

                        {% if applications %}
                        <div class="space-y-4">
                            {% for application in applications %}
                            <div
                                class="border border-[#e7e2da] dark:border-[#3a2d1b] rounded-xl p-5 hover:shadow-md transition-all">
                                <div class="flex items-start justify-between mb-3">
                                    <div class="flex-1">
                                        <h3 class="text-lg font-bold text-[#181510] dark:text-white mb-1">{{ application.program.name }}</h3>
                                        <p class="text-sm text-[#8d7a5e] dark:text-[#a19077]">{{ application.university.name }}</p>
                                    </div>
                                    <span
                                        class="px-3 py-1 rounded-full text-xs font-bold
                                        {% if application.status == 'accepted' %}bg-green-100 dark:bg-green-900/20 text-green-700 dark:text-green-300
                                        {% elif application.status == 'rejected' %}bg-red-100 dark:bg-red-900/20 text-red-700 dark:text-red-300
                                        {% elif application.status == 'pending' or application.status == 'under_review' %}bg-orange-100 dark:bg-orange-900/20 text-orange-700 dark:text-orange-300
                                        {% elif application.status == 'draft' %}bg-gray-100 dark:bg-gray-800 text-[#8d7a5e]
                                        {% else %}bg-blue-100 dark:bg-blue-900/20 text-blue-700 dark:text-blue-300{% endif %}">
                                        {{ application.get_status_display }}
                                    </span>
                                </div>

                                <div class="flex items-center text-sm text-[#8d7a5e] dark:text-[#a19077] mb-4">
                                    <span class="material-symbols-outlined text-base mr-1">calendar_today</span>
                                    Applied on {{ application.applied_on|date:"M d, Y" }}
                                </div>

                                <!-- Timeline Preview -->
                                <div class="flex items-center space-x-2 mb-4">
                                    {% with log_count=application.logs.count %}
                                    <div
                                        class="flex-1 h-2 {% if log_count >= 1 %}bg-primary{% else %}bg-gray-200 dark:bg-gray-700{% endif %} rounded-full">
                                    </div>
                                    <div
                                        class="flex-1 h-2 {% if log_count >= 2 %}bg-primary{% else %}bg-gray-200 dark:bg-gray-700{% endif %} rounded-full">
                                    </div>
                                    <div
                                        class="flex-1 h-2 {% if log_count >= 3 %}bg-primary{% else %}bg-gray-200 dark:bg-gray-700{% endif %} rounded-full">
                                    </div>
                                    {% endwith %}
                                </div>

                                <div class="flex gap-3">
                                    <a href="{% url 'applications:detail' application.application_id %}"
                                        class="flex-1 text-center px-4 py-2 bg-primary-10 border border-primary text-primary font-bold rounded-lg hover:bg-primary hover:text-white transition-all">
                                        View Details
                                    </a>
                                    {% if application.status == 'pending' %}
                                    <a href="{% url 'applications:cancel' application.application_id %}"
                                        onclick="return confirm('Are you sure you want to cancel this application? This action cannot be undone.');"
                                        class="flex-1 text-center px-4 py-2 bg-red-100 dark:bg-red-900/20 text-red-700 dark:text-red-300 font-bold rounded-lg hover:bg-red-200 dark:hover:bg-red-900/40 transition-all">
                                        Cancel Application
                                    </a>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="text-center py-12">
                            <div class="size-20 mx-auto text-[#8d7a5e]/30 mb-4">
                                <span class="material-symbols-outlined" style="font-size: 80px;">description</span>
                            </div>
                            <h3 class="text-lg font-bold text-[#181510] dark:text-white mb-2">No applications yet</h3>
                            <p class="text-[#8d7a5e] dark:text-[#a19077] mb-6">Start your journey by creating your first
                                application</p>
                            <a href="{% url 'applications:create' %}"
                                class="inline-flex items-center px-6 py-3 bg-primary text-[#181510] font-bold rounded-lg hover:opacity-90 transition-all">
                                Create Application
                                <span class="material-symbols-outlined ml-2">add</span>
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Sidebar -->
                <div class="lg:col-span-1 space-y-6">

                    <!-- My Profile -->
                    <div
                        class="bg-white dark:bg-[#1a1307] rounded-xl shadow-sm border border-[#e7e2da] dark:border-[#3a2d1b] p-6">
                        <h3 class="text-lg font-bold text-[#181510] dark:text-white mb-4">My Profile</h3>
                        <div class="flex items-center gap-4 mb-4">
                            {% if user.profile_picture %}
                            <img src="{{ user.profile_picture.url }}" alt="Profile"
                                class="w-12 h-12 rounded-full object-cover border-2 border-primary">
                            {% else %}
                            <div
                                class="w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center text-primary font-bold text-xl">
                                {{ user.first_name|first }}{{ user.last_name|first }}
                            </div>
                            {% endif %}
                            <div>
                                <p class="font-bold text-[#181510] dark:text-white">{{ user.get_full_name }}</p>
                                <p class="text-xs text-[#8d7a5e] dark:text-[#a19077]">{{ user.email }}</p>
                            </div>
                        </div>
                        <div class="space-y-2 text-sm text-[#8d7a5e] dark:text-[#a19077] mb-4">
                            <p><span class="font-medium text-[#181510] dark:text-white">Phone:</span> {{ user.phone }}
                            </p>
                            <p><span class="font-medium text-[#181510] dark:text-white">Nationality:</span> {{ user.nationality }}</p>
                        </div>
                        <a href="{% url 'students:profile' %}"
                            class="block w-full text-center px-4 py-2 bg-primary-10 text-primary font-bold rounded-lg hover:bg-primary hover:text-white transition-all">
                            Edit Profile
                        </a>
                    </div>

                    <!-- Documents -->
                    <div
                        class="bg-white dark:bg-[#1a1307] rounded-xl shadow-sm border border-[#e7e2da] dark:border-[#3a2d1b] p-6">
                        <h3
                            class="text-lg font-bold text-[#181510] dark:text-white mb-4 flex items-center justify-between">
                            <span>My Documents</span>
                            <span class="text-sm font-normal text-[#8d7a5e] dark:text-[#a19077]">{{ documents.count }}</span>
                        </h3>

                        {% if documents %}
                        <div class="space-y-3 mb-4">
                            {% for doc in documents|slice:":5" %}
                            <div
                                class="flex items-center justify-between p-3 bg-secondary-10 dark:bg-background-dark rounded-lg">
                                <div class="flex items-center flex-1 min-w-0">
                                    <span
                                        class="material-symbols-outlined text-secondary flex-shrink-0 mr-2">description</span>
                                    <div class="min-w-0 flex-1">
                                        <p class="text-sm font-medium text-text-secondary dark:text-white truncate">{{ doc.get_doc_type_display }}</p>
                                        <p class="text-xs text-text-secondary dark:text-[#a19077]">{{ doc.uploaded_at|date:"M d, Y" }}</p>
                                    </div>
                                </div>
                                <a href="{{ doc.file_url.url }}" target="_blank"
                                    class="ml-2 text-secondary hover:text-primary/80">
                                    <span class="material-symbols-outlined">download</span>
                                </a>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <p class="text-sm text-[#8d7a5e] dark:text-[#a19077] mb-4">No documents uploaded yet</p>
                        {% endif %}

                        <a href="{% url 'students:upload_document' %}"
                            class="block w-full text-center px-4 py-2 bg-primary-10 text-primary font-bold rounded-lg hover:bg-primary hover:text-white transition-all">
                            Upload Document
                        </a>
                    </div>

                    <!-- Quick Actions -->
                    <div
                        class="bg-white dark:bg-[#1a1307] rounded-xl shadow-sm border border-[#e7e2da] dark:border-[#3a2d1b] p-6">
                        <h3 class="text-lg font-bold text-[#181510] dark:text-white mb-4">Quick Actions</h3>
                        <div class="space-y-2">
                            <a href="{% url 'universities:list' %}"
                                class="block px-4 py-3 bg-secondary-10 dark:bg-background-dark rounded-lg hover:text-black transition-all text-secondary dark:text-white">
                                Browse Universities
                            </a>
                            <a href="{% url 'programs:list' %}"
                                class="block px-4 py-3 bg-secondary-10 dark:bg-background-dark rounded-lg  hover:text-black transition-all text-secondary dark:text-white">
                                Explore Programs
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</main>
{% endblock %}